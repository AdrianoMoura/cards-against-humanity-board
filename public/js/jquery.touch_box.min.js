/**
    Touch box - Enabled resize, drag & rotate of DOM elements on the web for iPad and other touch devices.
    Copyright (C) 2013 Dannie Hansen
 
    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with this program.  If not, see <http://www.gnu.org/licenses/>.
 **/
(function(a){window.touchBoxElement=null;for(var p=400,l="Transform",q="TransformOrigin",m=["O","ms","Webkit","Moz"],n=m.length,t=document.createElement("div").style;n--;)m[n]+l in t&&(l=m[n]+l,q=m[n]+q);a.fn.TouchBox=function(k){var g={drag:!1,resize:!1,rotate:!1,grid_drag:1,callback_touches:null,callback_size_change:null,callback_position_change:null,callback_degree_change:null};void 0!=k&&a.extend(g,k);this.each(function(){var d=a(this);a.data(d[0],"options",g);a.data(d[0],"touches",0);a.data(d[0],
"diffX",0);a.data(d[0],"diffY",0);a.data(d[0],"startWidth",0);a.data(d[0],"startHeight",0);a.data(d[0],"startDistance",0);a.data(d[0],"ignoreTouch",!1);a.data(d[0],"startX",0);a.data(d[0],"startY",0);a.data(d[0],"rotatePoint1X",0);a.data(d[0],"rotatePoint1Y",0);a.data(d[0],"rotatePoint2X",0);a.data(d[0],"rotatePoint2Y",0);a.data(d[0],"rotation",!1);a.data(d[0],"startDegree",0);a.data(d[0],"currDegree",0);a.data(d[0],"_startDegree",0);g.rotate&&d.css(q,"center center");this.draggable=!1;d.unbind("touchstart.touchBox mousedown.touchBox MSPointerDown.touchBox").bind("touchstart.touchBox mousedown.touchBox MSPointerDown.touchBox",
function(c){var b=a(this),d="undefined"!=typeof c.pageX?c.pageX:c.originalEvent.touches[0].pageX,f="undefined"!=typeof c.pageY?c.pageY:c.originalEvent.touches[0].pageY,e=a.data(b[0],"ignoreTouch"),h="undefined"!=typeof c.pageX?1:c.originalEvent.touches.length,r=a.data(b[0],"options");window.touchBoxElement=a(this);p+=1;b.css({zIndex:p});a.data(b[0],"touches",h);e&&(e=!1,a.data(b[0],"ignoreTouch",e));if(!e){var g=parseFloat(b.css("left"),10),k=parseFloat(b.css("top"),10),l=d,e=f;a.data(b[0],"startX",
g);a.data(b[0],"startY",k);a.data(b[0],"diffX",l-g);a.data(b[0],"diffY",e-k)}r.rotate&&(1==h?(a.data(b[0],"rotatePoint1X",d),a.data(b[0],"rotatePoint1Y",f)):2==h&&(d=c.originalEvent.touches[1].pageX,f=c.originalEvent.touches[1].pageY,e=a.data(b[0],"rotatePoint1X"),g=a.data(b[0],"rotatePoint1Y"),a.data(b[0],"rotatePoint2X",d),a.data(b[0],"rotatePoint2Y",f),a.data(b[0],"startDegree",180*Math.atan2(g-f,e-d)/Math.PI),a.data(b[0],"_startDegree",a.data(b[0],"currDegree")),a.data(b[0],"rotation",!0)));r.resize&&
2==h&&(a.data(b[0],"startWidth",b.width()),a.data(b[0],"startHeight",b.height()),l=c.originalEvent.touches[0].pageX,e=c.originalEvent.touches[0].pageY,h=c.originalEvent.touches[1].pageX-l,c=c.originalEvent.touches[1].pageY-e,c=Math.sqrt(h*h+c*c),a.data(b[0],"startDistance",c))});a(document).unbind("touchmove.touchBox mousemove.touchBox MSPointerMove.touchBox").bind("touchmove.touchBox mousemove.touchBox MSPointerMove.touchBox",function(c){if(null!==window.touchBoxElement){var b=window.touchBoxElement,
d=a.data(b[0],"touches"),f=a.data(b[0],"options");null!=f.callback_touches&&f.callback_touches.apply(window.touchBoxElement[0],[d]);if(f.resize&&2==d){var e=c.originalEvent.touches[0].pageX,h=c.originalEvent.touches[0].pageY,e=c.originalEvent.touches[1].pageX-e,h=c.originalEvent.touches[1].pageY-h,e=Math.sqrt(e*e+h*h),g=(e-a.data(b[0],"startDistance"))/2,h=a.data(b[0],"startWidth")+(e-a.data(b[0],"startDistance")),k=a.data(b[0],"startHeight")+(e-a.data(b[0],"startDistance")),e=a.data(b[0],"startX")-
g,g=a.data(b[0],"startY")-g;b.css({width:h+"px",height:k+"px",left:e+"px",top:g+"px"});null!=f.callback_size_change&&f.callback_size_change.apply(window.touchBoxElement[0],[h,k]);null!=f.callback_position_change&&f.callback_position_change.apply(window.touchBoxElement[0],[e,g])}f.drag&&!a.data(b[0],"ignoreTouch")&&1==d&&(e="undefined"!=typeof c.pageX?c.pageX:c.originalEvent.touches[0].pageX,h="undefined"!=typeof c.pageY?c.pageY:c.originalEvent.touches[0].pageY,e-=a.data(b[0],"diffX"),g=h-a.data(b[0],
"diffY"),b.css({left:Math.floor(e/f.grid_drag)*f.grid_drag+"px",top:Math.floor(g/f.grid_drag)*f.grid_drag+"px"}),null!=f.callback_position_change&&f.callback_position_change.apply(window.touchBoxElement[0],[e,g]));f.rotate&&a.data(b[0],"rotation")&&(d=a.data(b[0],"currDegree"),h=-1*(a.data(b[0],"startDegree")-180*Math.atan2(c.originalEvent.touches[0].pageY-c.originalEvent.touches[1].pageY,c.originalEvent.touches[0].pageX-c.originalEvent.touches[1].pageX)/Math.PI-a.data(b[0],"_startDegree")),a.data(b[0],
"currDegree",h),b.css(l,"rotate("+Math.floor(h)+"deg)"),null!=f.callback_degree_change&&f.callback_degree_change.apply(window.touchBoxElement[0],[d,h]));c.preventDefault()}}).unbind("touchend.touchBox mouseup.touchBox MSPointerUp.touchBox").bind("touchend.touchBox mouseup.touchBox MSPointerUp.touchBox",function(c){if(null!==window.touchBoxElement){c=window.touchBoxElement;var b=a.data(c[0],"options"),d=a.data(c[0],"touches");--d;a.data(c[0],"touches",d);1==d&&a.data(c[0],"ignoreTouch",!0);a.data(c[0],
"rotation",!1);null!=b.callback_touches&&b.callback_touches.apply(window.touchBoxElement[0],[d]);window.touchBoxElement=null}})})};a(document).ready(function(){var k=a(".touch-box");0<k.length&&k.each(function(){var g=a(this),d={drag:!1,resize:!1,rotate:!1,grid_drag:1},c=g.attr("data-resize"),b=g.attr("data-drag"),k=g.attr("data-rotate"),f=g.attr("data-grid");void 0!=c&&"true"==c&&(d.resize=!0);void 0!=b&&"true"==b&&(d.drag=!0);void 0!=k&&"true"==k&&(d.rotate=!0);void 0!=f&&(d.grid_drag=f);g.TouchBox(d)})})})(jQuery);